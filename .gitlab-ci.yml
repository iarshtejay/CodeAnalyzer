image: node:16.14.0

<<<<<<< HEAD
<<<<<<< HEAD
=======
=======
>>>>>>> 09504765 (Update .gitlab-ci.yml)
<<<<<<< HEAD
# default:
#   before_script:
#     - apt-get update -qy
#     - apt-get install -y ruby-dev
#     - apt-get install -u zip unzip
#     - gem install dpl

=======
>>>>>>> 4f46e01f (Update .gitlab-ci.yml)
<<<<<<< HEAD
=======
>>>>>>> 4f46e01f (Update .gitlab-ci.yml)
=======
>>>>>>> 8fbe579a (Update .gitlab-ci.yml)
>>>>>>> 09504765 (Update .gitlab-ci.yml)
cache:
  paths:
    - node_modules/

stages:
  - build
  - test
  - deploy_uat
<<<<<<< HEAD
  - deploy_frontend_prod
  - deploy_backend_prod
=======
  - deploy_backend_prod
<<<<<<< HEAD
<<<<<<< HEAD
  - deploy_frontend-prod
>>>>>>> 1dc92b68 (removing datetime)
=======
  - deploy_frontend_prod
>>>>>>> 3f7d437c (fixing uml typo)
=======
  - deploy_frontend-prod
>>>>>>> 29e49017 (removing datetime)
>>>>>>> 14324204 (removing datetime)
  - sonarqube-check

build:
  stage: build
  tags:
    - dalfcs_gitlab_docker_ci
  script:
    - cd codeanalyzer-backend
    # - npm install

test:
  stage: test
  script:
    - echo "Pipeline test started"
  tags:
    - dalfcs_gitlab_docker_ci

deploy_uat:
  stage: deploy_uat
  tags:
    - dalfcs_gitlab_docker_ci
  script:
    - echo "dbURL=$DATABASE_TEST_URL" >> .env
    - echo "dbUserName=$DATABASE_TEST_USERNAME" >> .env
    - echo "dbPassword=$DATABASE_TEST_PASSWORD" >> .env
    - echo "dbDriver=$DATABASE_DRIVER" >> .env
    - echo "Deploying the develop pipeline"
    - chmod og-rwx ${DEPLOY_SSH_KEY}
    - git clone https://git.cs.dal.ca/courses/2022-winter/csci-5308/group4.git
    - git checkout uat
    - cd group4
    - yarn
  only:
    - uat

<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 71a93dfa (Update .gitlab-ci.yml)
sonarqube-check:
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  variables:
    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar" # Defines the location of the analysis task cache
    GIT_DEPTH: "0" # Tells git to fetch all the branches of the project, required by the analysis task
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  allow_failure: true
  only:
    - qurram # or the name of your main branch

<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
deploy_prod:
  stage: deploy_prod
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
deploy_backend_prod:
<<<<<<< HEAD
  stage: deploy_backend_prod
>>>>>>> 64da8f70 (Update .gitlab-ci.yml)
=======
  stage: deploy_prod
>>>>>>> 8e4ae227 (fixing yaml)
=======
  skip_cleanup: true
>>>>>>> 70bb52fb (setting skip_cleanup)
=======
>>>>>>> ddc2f904 (updating node version)
=======
deploy_backend_prod:
<<<<<<< HEAD
  stage: deploy_backend_prod
>>>>>>> 1dc92b68 (removing datetime)
=======
deploy_backend_prod:
  stage: deploy_backend_prod
>>>>>>> 64da8f70 (Update .gitlab-ci.yml)
=======
  stage: deploy_prod
>>>>>>> 8e4ae227 (fixing yaml)
=======
  skip_cleanup: true
>>>>>>> 70bb52fb (setting skip_cleanup)
=======
>>>>>>> ddc2f904 (updating node version)
=======
deploy_backend_prod:
  stage: deploy_backend_prod
>>>>>>> 1dc92b68 (removing datetime)
=======
=======
>>>>>>> 14324204 (removing datetime)
deploy_backend_prod:
  stage: deploy_backend_prod
=======
=======
>>>>>>> 29e49017 (removing datetime)
deploy_prod:
  stage: deploy_prod
<<<<<<< HEAD
<<<<<<< HEAD
=======
deploy_backend_prod:
<<<<<<< HEAD
  stage: deploy_backend_prod
>>>>>>> 64da8f70 (Update .gitlab-ci.yml)
<<<<<<< HEAD
>>>>>>> 270a27e5 (Update .gitlab-ci.yml)
<<<<<<< HEAD
>>>>>>> 71a93dfa (Update .gitlab-ci.yml)
=======
=======
=======
  stage: deploy_prod
>>>>>>> 8e4ae227 (fixing yaml)
<<<<<<< HEAD
>>>>>>> 7dc25bae (fixing yaml)
<<<<<<< HEAD
>>>>>>> 1bac2f31 (fixing yaml)
=======
=======
=======
  skip_cleanup: true
>>>>>>> 70bb52fb (setting skip_cleanup)
<<<<<<< HEAD
>>>>>>> 912b4cc8 (setting skip_cleanup)
<<<<<<< HEAD
>>>>>>> 9b352453 (setting skip_cleanup)
=======
=======
=======
>>>>>>> ddc2f904 (updating node version)
<<<<<<< HEAD
>>>>>>> 5c499a40 (updating node version)
<<<<<<< HEAD
>>>>>>> bd56a4cb (updating node version)
=======
=======
=======
deploy_backend_prod:
  stage: deploy_backend_prod
>>>>>>> 1dc92b68 (removing datetime)
>>>>>>> 29e49017 (removing datetime)
>>>>>>> 14324204 (removing datetime)
  script:
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 0ebb1601 (fixing ruby version)
=======
>>>>>>> bc30f3d3 (updating to apt)
=======
>>>>>>> a6693267 (updating to apt)
=======
>>>>>>> 749fccfa (using rvm)
=======
>>>>>>> 57d67ab9 (adding faraday dependency)
    - apt-get update -qy
    - apt-get install -y ruby-full
    - apt-get install -u zip unzip
<<<<<<< HEAD
    - gem install faraday -v 1.10.0
=======
    - apt update -qy
=======
    - apt update -qy && apt upgrade
>>>>>>> fcac2f07 (updating to apt)
=======
    - apt update -qy && apt upgrade -y
>>>>>>> 9e93d31b (updating to apt)
    - apt install -y ruby-full
=======
    - apt-get update -qy && apt-get upgrade -y
    - apt-get install software-properties-common -y
    - gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
    - apt-add-repository -y ppa:rael-gc/rvm
    - apt-get update
    - apt-get install rvm
    - usermod -a -G rvm $USER
    - echo 'source "/etc/profile.d/rvm.sh"' >> ~/.bashrc
    - rvm install ruby
>>>>>>> 16ae378f (using rvm)
    # - apt-get install -u zip unzip
>>>>>>> 110eb121 (fixing ruby version)
=======
    - apt-get update -qy
    - apt-get install -y ruby-dev
    - apt-get install -u zip unzip
    - gem install faraday -v 1.10.0
>>>>>>> 5eac3195 (adding faraday dependency)
    - gem install dpl
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
    - cd codeanalyzer-backend
<<<<<<< HEAD
=======
    - cd code-analyzer-backend
>>>>>>> ddc2f904 (updating node version)
=======
    - npm config set legacy-peer-deps true
    - cd codeanalyzer-backend
>>>>>>> de9fe714 (node dependency fix)
=======
=======
    - apt update -qy
=======
    - apt update -qy && apt upgrade
>>>>>>> 7827fb20 (updating to apt)
=======
    - apt update -qy && apt upgrade -y
>>>>>>> 5cc3a38e (updating to apt)
    - apt install -y ruby-full
=======
    - apt-get update -qy && apt-get upgrade -y
    - apt-get install software-properties-common -y
    - gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
    - apt-add-repository -y ppa:rael-gc/rvm
    - apt-get update
    - apt-get install rvm
    - usermod -a -G rvm $USER
    - echo 'source "/etc/profile.d/rvm.sh"' >> ~/.bashrc
    - rvm install ruby
>>>>>>> 556bba47 (using rvm)
    # - apt-get install -u zip unzip
>>>>>>> 04f24ed8 (fixing ruby version)
=======
    - apt-get update -qy
    - apt-get install -y ruby-full
    - apt-get install -u zip unzip
<<<<<<< HEAD
    - gem install faraday -v 1.10.0
>>>>>>> 92bc3d19 (adding faraday dependency)
    - gem install dpl
<<<<<<< HEAD
<<<<<<< HEAD
    - cd codeanalyzer-backend
>>>>>>> 29376015 (updating backend deploy vars)
=======
    - cd code-analyzer-backend
>>>>>>> ddc2f904 (updating node version)
=======
=======
>>>>>>> bd56a4cb (updating node version)
=======
>>>>>>> 730d7779 (node dependency fix)
    - npm config set legacy-peer-deps true
=======
    - gem install dpl
>>>>>>> 03529e88 (updating backend deploy vars)
=======
<<<<<<< HEAD
>>>>>>> 5c499a40 (updating node version)
=======
<<<<<<< HEAD
>>>>>>> 2bc04362 (node dependency fix)
    - cd codeanalyzer-backend
<<<<<<< HEAD
<<<<<<< HEAD
>>>>>>> de9fe714 (node dependency fix)
=======
<<<<<<< HEAD
>>>>>>> 71a93dfa (Update .gitlab-ci.yml)
=======
=======
    - cd code-analyzer-backend
>>>>>>> ddc2f904 (updating node version)
<<<<<<< HEAD
>>>>>>> bd56a4cb (updating node version)
=======
=======
    - npm config set legacy-peer-deps true
    - cd codeanalyzer-backend
>>>>>>> de9fe714 (node dependency fix)
>>>>>>> 730d7779 (node dependency fix)
    - echo "DATABASE_HOST=$DATABASE_PROD_HOST" > .env
    - echo "DATABASE_PORT=$DATABASE_PROD_PORT" > .env
    - echo "DATABASE_NAME=$DATABASE_PROD_NAME" > .env
    - echo "DATABASE_USERNAME=$DATABASE_PROD_USERNAME" >> .env
    - echo "DATABASE_PASSWORD=$DATABASE_PROD_PASSWORD" >> .env
<<<<<<< HEAD
#    - echo "dbDriver=$DATABASE_DRIVER" >> .env
=======
<<<<<<< HEAD
    #    - echo "dbDriver=$DATABASE_DRIVER" >> .env
>>>>>>> 7b54fa8e (updating backend deploy vars)
    - echo "Deploying the release pipeline"
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
    - chmod og-rwx ${DEPLOY_PROD_SSH_KEY}
=======
>>>>>>> 821627c9 (fixing yaml)
=======
>>>>>>> 821627c9 (fixing yaml)
    - dpl --provider=heroku --app=$HEROKU_APP_BACKEND --api-key=$HEROKU_API_KEY
=======
    - dpl --provider=heroku --app=$HEROKU_APP --api-key=$HEROKU_API_KEY
>>>>>>> d5f1a8a8 (removing unnecessary permissions)
  only:
    - main
=======
    - echo "dbURL=$DATABASE_PROD_URL" > .env
    - echo "dbUserName=$DATABASE_PROD_USERNAME" >> .env
    - echo "dbPassword=$DATABASE_PROD_PASSWORD" >> .env
    - echo "dbDriver=$DATABASE_DRIVER" >> .env
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 64da8f70 (Update .gitlab-ci.yml)
    - echo "Deploying the backend release pipeline"
    - dpl --provider=heroku --app=$HEROKU_BACKEND_APP --api-key=$HEROKU_BACKEND_API_KEY

deploy_frontend_prod:
  stage: deploy_frontend_prod
  script:
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 92bc3d19 (adding faraday dependency)
    - apt-get update -qy
    - apt-get install -y ruby-dev
    - apt-get install -u zip unzip
    - gem install faraday -v 1.10.0
<<<<<<< HEAD
    - gem install dpl
    - npm config set legacy-peer-deps true
<<<<<<< HEAD
    - cd codeanalyzer-frontend
    - echo "Deploying the frontend release pipeline"
<<<<<<< HEAD
=======
    - echo "Deploying the release pipeline"
>>>>>>> d5f1a8a8 (removing unnecessary permissions)
    - dpl --provider=heroku --app=$HEROKU_APP --api-key=$HEROKU_API_KEY
<<<<<<< HEAD

only:
  - main
>>>>>>> 64da8f70 (Update .gitlab-ci.yml)
=======
=======
    - dpl --provider=heroku --app=$HEROKU_APP --api-key=$HEROKU_API_KEY --skip-cleanup
<<<<<<< HEAD
>>>>>>> 3f7d437c (fixing uml typo)
=======
    - chmod og-rwx ${DEPLOY_PROD_SSH_KEY}
    - dpl --provider=heroku --app=$HEROKU_APP_BACKEND --api-key=$HEROKU_API_KEY
>>>>>>> 29376015 (updating backend deploy vars)
=======
=======
#    - echo "dbDriver=$DATABASE_DRIVER" >> .env
    - echo "Deploying the release pipeline"
<<<<<<< HEAD
<<<<<<< HEAD
    - chmod og-rwx ${DEPLOY_PROD_SSH_KEY}
=======
>>>>>>> 821627c9 (fixing yaml)
    - dpl --provider=heroku --app=$HEROKU_APP_BACKEND --api-key=$HEROKU_API_KEY
<<<<<<< HEAD
>>>>>>> 03529e88 (updating backend deploy vars)
<<<<<<< HEAD
>>>>>>> 7b54fa8e (updating backend deploy vars)
=======
=======
=======
    - dpl --provider=heroku --app=$HEROKU_APP --api-key=$HEROKU_API_KEY
>>>>>>> d5f1a8a8 (removing unnecessary permissions)
>>>>>>> 23eacb92 (removing unnecessary permissions)
>>>>>>> ce0555f3 (removing unnecessary permissions)
  only:
    - main
<<<<<<< HEAD
>>>>>>> f889e6db (fixing yaml)
=======
=======
    - apt-get update -qy
    - apt-get install -y ruby-dev
    - apt-get install -u zip unzip
=======
    - apt update -qy
=======
    - apt update -qy && apt upgrade
>>>>>>> 7827fb20 (updating to apt)
=======
    - apt update -qy && apt upgrade -y
>>>>>>> 5cc3a38e (updating to apt)
    - apt install -y ruby-full
=======
    - apt-get update -qy && apt-get upgrade -y
    - apt-get install software-properties-common -y
    - gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
    - apt-add-repository -y ppa:rael-gc/rvm
    - apt-get update
    - apt-get install rvm
    - usermod -a -G rvm $USER
    - echo 'source "/etc/profile.d/rvm.sh"' >> ~/.bashrc
    - rvm install ruby
>>>>>>> 556bba47 (using rvm)
    # - apt-get install -u zip unzip
>>>>>>> 04f24ed8 (fixing ruby version)
=======
>>>>>>> 92bc3d19 (adding faraday dependency)
    - gem install dpl
>>>>>>> 4f46e01f (Update .gitlab-ci.yml)
=======
>>>>>>> de9fe714 (node dependency fix)
    - cd codeanalyzer-frontend
    - echo "Deploying the frontend release pipeline"
<<<<<<< HEAD
    - dpl --provider=heroku --app=$HEROKU_APP --api-key=$HEROKU_API_KEY
<<<<<<< HEAD
=======
=======
    - echo "dbURL=$DATABASE_PROD_URL" > .env
    - echo "dbUserName=$DATABASE_PROD_USERNAME" >> .env
    - echo "dbPassword=$DATABASE_PROD_PASSWORD" >> .env
    - echo "dbDriver=$DATABASE_DRIVER" >> .env
    - echo "Deploying the backend release pipeline"
    - dpl --provider=heroku --app=$HEROKU_BACKEND_APP --api-key=$HEROKU_BACKEND_API_KEY

deploy_frontend_prod:
  stage: deploy_frontend_prod
  script:
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
    - apt-get update -qy
    - apt-get install -y ruby-dev
    - apt-get install -u zip unzip
=======
    - apt update -qy
=======
    - apt update -qy && apt upgrade
>>>>>>> fcac2f07 (updating to apt)
=======
    - apt update -qy && apt upgrade -y
>>>>>>> 9e93d31b (updating to apt)
    - apt install -y ruby-full
=======
    - apt-get update -qy && apt-get upgrade -y
    - apt-get install software-properties-common -y
    - gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB
    - apt-add-repository -y ppa:rael-gc/rvm
    - apt-get update
    - apt-get install rvm
    - usermod -a -G rvm $USER
    - echo 'source "/etc/profile.d/rvm.sh"' >> ~/.bashrc
    - rvm install ruby
>>>>>>> 16ae378f (using rvm)
    # - apt-get install -u zip unzip
>>>>>>> 110eb121 (fixing ruby version)
=======
    - apt-get update -qy
    - apt-get install -y ruby-dev
    - apt-get install -u zip unzip
    - gem install faraday -v 1.10.0
>>>>>>> 5eac3195 (adding faraday dependency)
    - gem install dpl
    - npm config set legacy-peer-deps true
    - cd codeanalyzer-frontend
    - echo "Deploying the frontend release pipeline"
    - dpl --provider=heroku --app=$HEROKU_APP --api-key=$HEROKU_API_KEY
>>>>>>> 71a93dfa (Update .gitlab-ci.yml)

only:
  - main
>>>>>>> 64da8f70 (Update .gitlab-ci.yml)
<<<<<<< HEAD
=======
=======
    - dpl --provider=heroku --app=$HEROKU_APP --api-key=$HEROKU_API_KEY --skip-cleanup
>>>>>>> 3f7d437c (fixing uml typo)
  only:
    - main
>>>>>>> f889e6db (fixing yaml)
=======
>>>>>>> 71a93dfa (Update .gitlab-ci.yml)
